# docker-compose.yaml
# Symfony 8 + PHP 8.4 + Nginx + MariaDB + RabbitMQ + Redis + Mailpit (2026 best practices)

services:
  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: symfony_php
    restart: unless-stopped
    volumes:
      - ./api:/var/www/symfony:z          # :z for Podman/Fedora SELinux compatibility
    depends_on:
      - db
      - rabbitmq
      - redis
    environment:
      APP_ENV: dev
      APP_SECRET: ${APP_SECRET:-changeme_in_.env.local}
      DATABASE_URL: "postgresql://app:app@db:5432/symfony?serverVersion=16&charset=utf8"
      MESSENGER_TRANSPORT_DSN: "amqp://guest:guest@rabbitmq:5672/%2f/messages"  # ← RabbitMQ DSN for Symfony Messenger
    networks:
      - symfony_net

  nginx:
    image: nginx:alpine
    container_name: symfony_nginx
    restart: unless-stopped
    ports:
      - "8080:80"                         # → http://localhost:8080 in dev
    volumes:
      - ./api:/var/www/symfony:z
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php
    networks:
      - symfony_net

  db:
    image: postgres:16-alpine   # alpine variant = smaller & faster for dev; use postgres:16 if you prefer full Debian base
    container_name: symfony_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: app          # creates user 'app'
      POSTGRES_PASSWORD: app      # password for 'app' user
      POSTGRES_DB: symfony        # creates database 'symfony' owned by 'app'
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"               # optional: expose for local tools like pgAdmin/DBeaver; remove in prod
    networks:
      - symfony_net

  rabbitmq:
    image: rabbitmq:3.13-management     # latest stable with management UI (as of 2026)
    container_name: symfony_rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      # Optional: customize vhost/exchange if needed
      # RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5672:5672"                       # AMQP protocol (for Messenger)
      - "15672:15672"                     # Management UI → http://localhost:15672 (user: guest / pass: guest)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
    networks:
      - symfony_net

  redis:
    image: redis:alpine
    container_name: symfony_redis
    restart: unless-stopped
    networks:
      - symfony_net

  mailpit:
    image: axllent/mailpit:latest
    container_name: symfony_mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP
    networks:
      - symfony_net

volumes:
  db_data:
  rabbitmq_data:
  rabbitmq_logs:

networks:
  symfony_net:
    driver: bridge